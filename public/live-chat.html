<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Live Chat | H. Index</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <link rel="stylesheet" href="styles.css">
  <style>
    body { background-color: #f9fafb; font-family: Inter, ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji"; }
    .chat-container { background-color: #ffffff; border-radius: 8px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); padding: 1.5rem; margin-top: 2rem; max-width: 800px; }
    .chat-box { border: 1px solid #e5e7eb; padding: 1rem; height: 60vh; min-height: 400px; overflow-y: auto; margin-bottom: 1rem; background-color: #f3f4f6; border-radius: 8px; scroll-behavior: smooth; }
    .message { margin-bottom: 0.75rem; padding: 0.6rem 1rem; border-radius: 18px; max-width: 80%; word-wrap: break-word; line-height: 1.4; font-size: 0.95rem; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
    .message-sent { background-color: #f59e0b; color: white; margin-left: auto; border-bottom-right-radius: 6px; }
    .message-received { background-color: #e5e7eb; color: #1f2937; margin-right: auto; border-bottom-left-radius: 6px; }
    .message-received strong { color: #4b5563; font-weight: 600; display: block; font-size: 0.8rem; margin-bottom: 2px; }
    .message-system { background-color: #dbeafe; color: #1e40af; font-size: 0.85rem; text-align: center; max-width: 90%; margin-left: auto; margin-right: auto; padding: 0.4rem 0.8rem; border-radius: 6px; }
    .message .timestamp { font-size: 0.7em; color: #9ca3af; display: block; margin-top: 4px; opacity: 0.8; }
    .message-sent .timestamp { text-align: right; color: #ffedd5; }
    .message-received .timestamp { text-align: left; }
    .chat-info { border-bottom: 1px solid #e5e7eb; padding-bottom: 1rem; margin-bottom: 1.5rem; }
    .chat-info p { margin: 0.25rem 0; color: #4b5563;}
    .chat-info strong { color: #1f2937; }
    .input-area { display: flex; gap: 0.5rem; align-items: center; }
    #messageInput { flex-grow: 1; border: 1px solid #d1d5db; border-radius: 6px; padding: 0.75rem 1rem; outline: none; transition: border-color 0.2s ease-in-out, box-shadow 0.2s ease-in-out; color: #1f2937; background-color: #ffffff; }
    #messageInput:focus { border-color: #f59e0b; box-shadow: 0 0 0 2px rgba(245, 158, 11, 0.3); }
    #attachFileButton { flex-shrink: 0; padding: 0.5rem; border-radius: 6px; transition: background-color 0.2s; }
    #attachFileButton:hover:not(:disabled) { background-color: #e5e7eb; }
    #attachFileButton:disabled { opacity: 0.5; cursor: not-allowed; }
    .send-button { background: #f59e0b; color: white; font-weight: 600; padding: 0.75rem 1.25rem; border: none; border-radius: 6px; cursor: pointer; transition: background-color 0.3s ease, transform 0.1s ease; flex-shrink: 0; height: fit-content; }
    .send-button:hover:not(:disabled) { background: #d97706; }
    .send-button:active:not(:disabled) { transform: scale(0.96); }
    .send-button:disabled { background-color: #fbbf24; cursor: not-allowed; opacity: 0.7; }
    #chatError, #uploadProgress { min-height: 1.25rem; }
    .mobile-menu { display: none; }
    .mobile-menu.active { display: block; max-height: 500px; overflow: hidden;}
    .message a { color: inherit; }
    .message-sent a { color: white; text-decoration: underline; }
    .message-received a { color: #1d4ed8; text-decoration: underline; }
    .message-received a:hover { color: #1e40af; }
    .message-sent a:hover { filter: brightness(90%); }
  </style>
</head>
<body class="bg-gray-100 text-gray-800 font-sans">
  <!-- Navbar -->
  <nav class="bg-white p-4 shadow-md sticky top-0 z-50"> <div class="container mx-auto flex justify-between items-center"> <div class="flex items-center space-x-2"> <div class="bg-yellow-400 p-2 rounded-full"> <i class="fas fa-flask text-white text-xl"></i> </div> <h1 class="text-2xl font-bold text-gray-800">H. Index</h1> </div> <ul class="hidden md:flex space-x-8 text-gray-700 font-medium items-center"> <li><a href="#" id="dashboardLink" class="hover:text-yellow-500 transition">Dashboard</a></li> <li><button onclick="logout()" class="hover:text-yellow-500 transition px-3 py-1">Logout</button></li> </ul> <button id="mobile-menu-button" class="md:hidden text-gray-700 focus:outline-none"> <i class="fas fa-bars text-2xl"></i> </button> </div> <div id="mobile-menu" class="mobile-menu md:hidden bg-white absolute top-full left-0 right-0 shadow-md z-40"> <ul class="flex flex-col items-center py-4 space-y-3"> <li><a href="#" id="mobileDashboardLink" class="block w-full text-center hover:text-yellow-500 transition px-4 py-2" onclick="closeMobileMenu()">Dashboard</a></li> <li><button onclick="logout(); closeMobileMenu();" class="block w-full text-center hover:text-yellow-500 transition px-4 py-2">Logout</button></li> </ul> </div> </nav>

  <!-- Live Chat Section -->
  <section class="py-8 md:py-12">
    <div class="container mx-auto px-4 sm:px-6">
        <div class="chat-container mx-auto">
            <div class="chat-info">
                <h2 class="text-xl font-bold mb-3 text-gray-800">Live Chat Session</h2>
                <p id="task-info" class="text-sm text-gray-700 font-medium">Task: <span class="font-normal text-gray-600">Loading details...</span></p>
                <p id="participant-info" class="text-sm text-gray-700 font-medium">Participants: <span class="font-normal text-gray-600">Loading...</span></p>
                <p id="connection-status" class="text-sm text-gray-500 italic mt-1">Connecting...</p>
            </div>
            <div id="chatBox" class="chat-box"> <p id="chat-loading" class="text-center text-gray-400 p-4"> <i class="fas fa-spinner fa-spin mr-2"></i>Loading chat history... </p> </div>
             <div class="input-area mt-4">
                <button id="attachFileButton" type="button" class="p-2 text-gray-500 hover:text-gray-700 focus:outline-none" title="Attach File" onclick="document.getElementById('fileInput').click();" disabled> <i class="fas fa-paperclip text-xl"></i> </button>
                <input type="file" id="fileInput" style="display: none;" accept=".jpg, .jpeg, .png, .gif, .pdf, .doc, .docx, .txt">
                <input type="text" id="messageInput" placeholder="Type your message here..." autocomplete="off" class="text-sm sm:text-base flex-grow border border-gray-300 rounded-md py-2 px-3 focus:outline-none focus:ring-1 focus:ring-amber-500 focus:border-amber-500" disabled>
                <button id="sendButton" onclick="sendMessage()" class="send-button ml-2" title="Send Message" disabled> <i class="fas fa-paper-plane"></i> <span class="sr-only">Send</span> </button>
            </div>
            <div id="uploadProgress" class="text-sm text-gray-600 mt-1 h-4"></div>
            <div id="chatError" class="text-red-600 text-sm text-center mt-1 h-5"></div>
        </div>
    </div>
  </section>

  <script src="/socket.io/socket.io.js"></script>
  <script src="scripts.js"></script>
  <script>
      let currentTaskId = null; let currentUser = null;
      const chatBox = document.getElementById('chatBox'); const messageInput = document.getElementById('messageInput'); const sendButton = document.getElementById('sendButton'); const taskInfoElement = document.getElementById('task-info').querySelector('span'); const participantInfoElement = document.getElementById('participant-info').querySelector('span'); const connectionStatusElement = document.getElementById('connection-status'); const chatLoadingElement = document.getElementById('chat-loading'); const chatErrorElement = document.getElementById('chatError'); const dashboardLink = document.getElementById('dashboardLink'); const mobileDashboardLink = document.getElementById('mobileDashboardLink'); const fileInput = document.getElementById('fileInput'); const attachFileButton = document.getElementById('attachFileButton'); const uploadProgressElement = document.getElementById('uploadProgress');
      function scrollToBottom(force = false) { if (!chatBox) return; const threshold = 100; const isScrolledToBottom = chatBox.scrollHeight - chatBox.scrollTop - chatBox.clientHeight < threshold; if (force || isScrolledToBottom) { requestAnimationFrame(() => { chatBox.scrollTo({ top: chatBox.scrollHeight, behavior: force ? 'auto' : 'smooth' }); }); } }
      function formatTimestamp(isoTimestamp) { if (!isoTimestamp) return ''; try { return new Date(isoTimestamp).toLocaleString([], { dateStyle: 'short', timeStyle: 'short' }); } catch (e) { return 'Invalid Date'; } }
      function displayMessage(message, isHistory = false) { if (!chatBox || !message || !message.sender) return; if (chatLoadingElement && chatBox.contains(chatLoadingElement)) { chatLoadingElement.remove(); } const messageElement = document.createElement('div'); let messageClass = ''; let senderDisplayName = ''; if (message.sender.role === 'system') { messageClass = 'message-system'; senderDisplayName = ''; } else if (currentUser && message.sender.id === currentUser.id) { messageClass = 'message-sent'; senderDisplayName = ''; } else { messageClass = 'message-received'; senderDisplayName = `<strong>${message.sender.name || message.sender.role || 'Unknown'}</strong>`; } messageElement.classList.add('message', messageClass); const formattedTime = formatTimestamp(message.timestamp || Date.now()); let messageContentHtml = ''; if (message.messageType === 'file' && message.fileUrl && message.text) { const fileUrl = message.fileUrl; const fileName = message.text; let fileIcon = 'fa-file-alt'; if (message.mimeType?.startsWith('image/')) { fileIcon = 'fa-file-image'; } else if (message.mimeType === 'application/pdf') { fileIcon = 'fa-file-pdf'; } else if (message.mimeType?.includes('word')) { fileIcon = 'fa-file-word'; } messageContentHtml = ` <a href="${fileUrl}" target="_blank" rel="noopener noreferrer" class="flex items-center group" title="Download ${fileName}"> <i class="fas ${fileIcon} mr-2 text-lg opacity-80 group-hover:opacity-100 transition-opacity"></i> <span class="flex-1 group-hover:underline break-all">${fileName}</span> </a>`; } else { const sanitizedText = (message.text || '').replace(/</g, "<").replace(/>/g, ">"); messageContentHtml = `<p>${sanitizedText.replace(/\n/g, '<br>')}</p>`; } messageElement.innerHTML = ` ${senderDisplayName} ${messageContentHtml} <span class="timestamp">${formattedTime}</span>`; chatBox.appendChild(messageElement); if (!isHistory) { scrollToBottom(); } }
      async function fetchChatData(taskId) { if (!taskInfoElement || !chatBox || !participantInfoElement) return; taskInfoElement.textContent = `Loading details...`; participantInfoElement.textContent = `Loading...`; chatBox.innerHTML = ''; chatBox.appendChild(chatLoadingElement); chatLoadingElement.style.display = 'block'; chatErrorElement.textContent = ''; try { const token = getAuthToken(); if (!token) throw new Error('Authentication required.'); const taskDetails = await makeApiRequest(`/api/tasks/${taskId}/details`, 'GET', null, token); taskInfoElement.textContent = `${taskDetails.service || 'N/A'} (Status: ${taskDetails.status || 'N/A'})`; participantInfoElement.textContent = `Client: ${taskDetails.client?.name || '?'} | Freelancer: ${taskDetails.freelancer?.name || '?'}`; const messages = await makeApiRequest(`/api/chat/${taskId}/history`, 'GET', null, token); chatLoadingElement.style.display = 'none'; if (messages.length > 0) { messages.forEach(msg => displayMessage(msg, true)); } else { displayMessage({ sender: { role: 'system', name: 'System' }, text: 'No chat history yet. Start the conversation!' }, true); } requestAnimationFrame(() => scrollToBottom(true)); if (taskDetails.status === 'accepted' || taskDetails.status === 'completed') { messageInput.disabled = false; sendButton.disabled = false; attachFileButton.disabled = false; messageInput.placeholder = "Type your message here..."; } else { messageInput.disabled = true; sendButton.disabled = true; attachFileButton.disabled = true; messageInput.placeholder = `Chat is disabled (Task status: ${taskDetails.status})`; } } catch (error) { console.error("Error fetching chat data:", error); taskInfoElement.textContent = `Error loading details.`; participantInfoElement.textContent = `-`; chatLoadingElement.style.display = 'none'; chatBox.innerHTML = `<p class="text-red-600 text-center p-4">Failed to load chat data: ${error.message}</p>`; messageInput.disabled = true; sendButton.disabled = true; attachFileButton.disabled = true; } }
      function sendMessage() { if (!socket || !socket.connected) { chatErrorElement.textContent = "Error: Not connected to chat server."; connectionStatusElement.textContent = "Disconnected"; connectionStatusElement.style.color = 'red'; return; } if (messageInput.disabled) { chatErrorElement.textContent = "Chat is currently disabled."; return; } chatErrorElement.textContent = ""; const messageText = messageInput.value.trim(); if (!messageText || !currentUser || !currentTaskId) { return; } const messagePayload = { taskId: currentTaskId, text: messageText, messageType: 'text' }; socket.emit('send-chat-message', messagePayload); logDebug("Sent TEXT message via Socket:", messagePayload); const optimisticMessage = { taskId: currentTaskId, text: messageText, messageType: 'text', sender: { id: currentUser.id, role: currentUser.role, name: currentUser.name || currentUser.email }, timestamp: new Date().toISOString() }; displayMessage(optimisticMessage); messageInput.value = ''; messageInput.focus(); scrollToBottom(true); }
      if (fileInput) { fileInput.addEventListener('change', handleFileSelect); }
      function handleFileSelect(event) { const file = event.target.files[0]; if (!file) return; const maxSizeMB = 10; const maxSize = maxSizeMB * 1024 * 1024; chatErrorElement.textContent = ''; if (file.size > maxSize) { chatErrorElement.textContent = `File is too large (Max: ${maxSizeMB} MB).`; fileInput.value = ''; return; } uploadFile(file); fileInput.value = ''; }
      async function uploadFile(file) { if (!currentTaskId || !currentUser || !socket || !socket.connected) { chatErrorElement.textContent = "Cannot upload file: Connection or authentication issue."; return; } if (messageInput.disabled) { chatErrorElement.textContent = "Cannot upload file while chat is disabled."; return; } const formData = new FormData(); formData.append('chatFile', file); messageInput.disabled = true; sendButton.disabled = true; attachFileButton.disabled = true; uploadProgressElement.innerHTML = `<i class="fas fa-spinner fa-spin mr-1 text-xs"></i>Uploading ${file.name}...`; chatErrorElement.textContent = ''; try { const token = getAuthToken(); if (!token) throw new Error("Authentication token missing."); logDebug(`Uploading file: ${file.name} to /api/chat/${currentTaskId}/upload`); const response = await fetch(`${API_BASE_URL}/api/chat/${currentTaskId}/upload`, { method: 'POST', headers: { 'Authorization': `Bearer ${token}` }, body: formData, }); const result = await response.json(); if (!response.ok) throw new Error(result.message || `Upload failed (Status ${response.status})`); logDebug('File upload successful:', result); uploadProgressElement.textContent = ``; const fileMessagePayload = { taskId: currentTaskId, messageType: 'file', fileName: result.fileName, fileUrl: result.fileUrl, mimeType: result.mimeType, text: result.fileName }; socket.emit('send-chat-message', fileMessagePayload); logDebug('Sent FILE message notification via Socket:', fileMessagePayload); const optimisticFileMessage = { taskId: currentTaskId, messageType: 'file', text: result.fileName, fileUrl: result.fileUrl, mimeType: result.mimeType, sender: { id: currentUser.id, role: currentUser.role, name: currentUser.name || currentUser.email }, timestamp: new Date().toISOString() }; displayMessage(optimisticFileMessage); scrollToBottom(true); } catch (error) { logError('File upload failed:', error); uploadProgressElement.textContent = ''; chatErrorElement.textContent = `Upload failed: ${error.message}`; } finally { const taskDetails = await makeApiRequest(`/api/tasks/${currentTaskId}/details`, 'GET', null, getAuthToken()).catch(() => null); if (taskDetails && (taskDetails.status === 'accepted' || taskDetails.status === 'completed')) { messageInput.disabled = false; sendButton.disabled = false; attachFileButton.disabled = false; messageInput.focus(); } else { messageInput.placeholder = `Chat is disabled (Task status: ${taskDetails?.status || 'Unknown'})`; messageInput.disabled = true; sendButton.disabled = true; attachFileButton.disabled = true; } } }
      document.addEventListener('DOMContentLoaded', () => { currentUser = getLoggedInUser(); if (!currentUser) { alert('Please log in to access chat.'); window.location.href = 'login.html'; return; } const dashboardUrl = currentUser.role === 'client' ? 'client-dashboard.html' : 'freelancer-dashboard.html'; if(dashboardLink) dashboardLink.href = dashboardUrl; if(mobileDashboardLink) mobileDashboardLink.href = dashboardUrl; const urlParams = new URLSearchParams(window.location.search); currentTaskId = urlParams.get('taskId'); if (!currentTaskId) { alert('Error: Task ID is missing from the URL.'); taskInfoElement.textContent = 'Error: Task ID not specified.'; participantInfoElement.textContent = '-'; messageInput.disabled = true; sendButton.disabled = true; attachFileButton.disabled = true; chatBox.innerHTML = '<p class="text-red-600 text-center p-4">Error: Task ID missing.</p>'; return; } logDebug(`Chat page loaded for Task ID: ${currentTaskId}`); fetchChatData(currentTaskId); if (!socket || !socket.connected) { connectionStatusElement.textContent = "Connecting..."; socket = connectSocket(); if(!socket) { connectionStatusElement.textContent = "Connection Failed!"; connectionStatusElement.style.color = 'red'; chatErrorElement.textContent = "Could not establish connection to chat server."; return; } } if (socket.connected) { joinChatRoom(); } else { socket.once('connect', joinChatRoom); } socket.off('chat-room-joined'); socket.off('chat-message'); socket.off('chat-error'); socket.off('connect'); socket.off('disconnect'); socket.off('connect_error'); socket.on('chat-room-joined', (data) => { if(data.taskId === currentTaskId) { logDebug(`Successfully joined chat room: ${data.room}`); connectionStatusElement.textContent = "Connected"; connectionStatusElement.style.color = 'green'; chatErrorElement.textContent = ''; } }); socket.on('chat-message', (message) => { logDebug('Received chat message via Socket:', message); if (currentUser && message.sender && message.sender.id === currentUser.id) { logDebug('Ignoring own message received via broadcast.'); return; } if (message.taskId === currentTaskId) { displayMessage(message); } else { logWarn(`Received message for different task (${message.taskId}), ignoring.`); } }); socket.on('chat-error', (error) => { logError('Chat Error from Server:', error.message); chatErrorElement.textContent = `Error: ${error.message}`; connectionStatusElement.textContent = "Connection Issue"; connectionStatusElement.style.color = 'red'; }); socket.on('connect', () => { connectionStatusElement.textContent = "Connected"; connectionStatusElement.style.color = 'green'; chatErrorElement.textContent = ''; joinChatRoom(); }); socket.on('disconnect', (reason) => { connectionStatusElement.textContent = `Disconnected: ${reason}`; connectionStatusElement.style.color = 'red'; chatErrorElement.textContent = "Connection lost. Attempting to reconnect..."; messageInput.disabled = true; sendButton.disabled = true; attachFileButton.disabled = true; }); socket.on('connect_error', (err) => { connectionStatusElement.textContent = "Connection Error"; connectionStatusElement.style.color = 'red'; chatErrorElement.textContent = "Could not connect to chat server."; messageInput.disabled = true; sendButton.disabled = true; attachFileButton.disabled = true; }); messageInput.addEventListener('keypress', event => { if (event.key === 'Enter' && !event.shiftKey) { event.preventDefault(); if (!sendButton.disabled) { sendMessage(); } } }); if(!messageInput.disabled) { messageInput.focus(); } });
      function joinChatRoom() { if (socket && socket.connected && currentTaskId && currentUser && currentUser.id) { socket.emit('join-task-chat-room', { taskId: currentTaskId, userId: currentUser.id }); logDebug(`Attempting to join chat room for task ${currentTaskId} as user ${currentUser.id}`); connectionStatusElement.textContent = "Joining chat room..."; } else { logWarn("Cannot join chat room: Socket not ready or missing info.", { socketReady: socket?.connected, taskId: currentTaskId, userId: currentUser?.id }); connectionStatusElement.textContent = "Error joining chat"; connectionStatusElement.style.color = 'red'; } }
      const menuButtonChat = document.getElementById('mobile-menu-button'); const mobileMenuChat = document.getElementById('mobile-menu'); const mobileMenuLinksChat = mobileMenuChat?.querySelectorAll('a, button'); function closeMobileMenu() { mobileMenuChat?.classList.remove('active'); } if(menuButtonChat && mobileMenuChat) { menuButtonChat.addEventListener('click', () => { mobileMenuChat.classList.toggle('active'); }); if(mobileMenuLinksChat) { mobileMenuLinksChat.forEach(link => { link.addEventListener('click', closeMobileMenu); }); } document.addEventListener('click', function(event) { if(mobileMenuChat.classList.contains('active')) { const isClickInsideNav = menuButtonChat.contains(event.target) || mobileMenuChat.contains(event.target); if (!isClickInsideNav) { closeMobileMenu(); } } }); }
  </script>
</body>
</html>